<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/src/styles/style.css" />
  <link rel="stylesheet" href="/src/styles/navbar.css" />
  <style>
    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 5px;
      background-color: white;
    }

    .task-item span {
      flex-grow: 1;
      overflow-wrap: break-word;
    }

    .task-item button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .task-item button:hover {
      background-color: #eee;
      border-radius: 4px;
    }

    button.clear-all {
      margin: 5px 0 15px;
      background-color: #7b7878;
      border: 1px solid #616161;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    button.clear-all:hover {
      background-color: #e4e4e4;
    }
  </style>
</head>
<body>
  <main>
    <h1>Task History ‚Äì Last 30 Days</h1>
    <div id="history-summary"></div>

    <section>
      <h3>‚úÖ Completed Tasks</h3>
      <button id="clear-completed" class="clear-all">üßπ Clear All History</button>
      <ul id="completed-list"></ul>
    </section>

    <section>
      <h3>‚ö†Ô∏è Missed Tasks</h3>
      <ul id="missed-list"></ul>
    </section>
  </main>
  <footer class="footer">
    <p>¬© 2025 My To-Do App. Made with ‚ù§Ô∏è by Tracie.</p>
  </footer>

  <script type="module">
    import { renderNavbar } from '/src/navbar.js';
    import { db, auth } from '/src/firebase.js';
    import { ref, onValue, remove } from "firebase/database";
    import { onAuthStateChanged } from "firebase/auth";

    renderNavbar();

    const completedList = document.getElementById("completed-list");
    const missedList = document.getElementById("missed-list");
    const summary = document.getElementById("history-summary");
    const clearCompletedBtn = document.getElementById("clear-completed");

    const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30;
    const now = new Date();

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }

      const userId = user.uid;
      const historyRef = ref(db, `history/${userId}`);

      let completedCount = 0;
      let missedCount = 0;

      onValue(historyRef, (snapshot) => {
        completedList.innerHTML = "";
        missedList.innerHTML = "";
        completedCount = 0;
        missedCount = 0;

        snapshot.forEach((child) => {
          const task = child.val();
          const taskId = child.key;
          const createdAt = new Date(task.createdAt);
          const deadline = task.deadline ? new Date(task.deadline) : null;
          const isRecent = (now - createdAt <= THIRTY_DAYS);

          if (!isRecent) return;

          const li = document.createElement("li");
          li.classList.add("task-item");

          const span = document.createElement("span");
          span.textContent = `${task.text} (${task.deadline ? "Due: " + task.deadline : "No deadline"})`;

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "üóëÔ∏è";
          deleteBtn.title = "Delete this task from history";
          deleteBtn.addEventListener("click", () => {
            if (confirm("Delete this task from history?")) {
              remove(ref(db, `history/${userId}/${taskId}`));
            }
          });

          li.appendChild(span);
          li.appendChild(deleteBtn);

          if (task.completed) {
            completedCount++;
            completedList.appendChild(li);
          } else if (!task.completed && deadline && deadline < now) {
            missedCount++;
            missedList.appendChild(li);
          }
        });

        updateSummary();
      });

      clearCompletedBtn.addEventListener("click", () => {
        if (confirm("Clear ALL history (completed + missed)?")) {
          remove(historyRef).then(() => {
            alert("‚úÖ All task history cleared.");
          });
        }
      });

      function updateSummary() {
        summary.innerHTML = `
          <p><strong>‚úÖ Completed tasks:</strong> ${completedCount}</p>
          <p><strong>‚ö†Ô∏è Missed tasks:</strong> ${missedCount}</p>
        `;
      }
    });
  </script>
</body>
</html>
